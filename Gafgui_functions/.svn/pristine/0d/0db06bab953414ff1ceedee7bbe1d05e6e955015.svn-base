
% --------------------------------------------------------------------
function [P,XI,SI] = fct_makecorrmatrix2(N,xi,F,x,s)

Nbin = 64;

if length(x)<3
    xmin = min(x);
    xmax = max(x);
    deltax = (xmax-xmin)/Nbin;
    x = xmin:deltax:xmax;
end
if length(s)<3
    smin = min(s);
    smax = max(s);
    deltas = (smax-smin)/Nbin;
    s = smin:deltas:smax;
end

center(1:N) = 0;
P = [];
for i=1:N
    y = F{i};
    k = min(find(abs(xi)==min(abs(xi))));
    norm = 1;
    if y(k)~=0
        norm = y(k);
    end
    if y(k)==0
        P = cat(1,P,y*0+1);
    else
        P = cat(1,P,y/norm);
    end
    center(i) = y(k);
end
%extrapolation
if center(1) == 0
else
    P = cat(1,y*0,P);
    center = [0 center(:)']';
end
if center(length(center)) == 65535
else
    P = cat(1,P,y*0+1);
    center = [center(:)' 65535]';
end
%%%%
[X,S] = meshgrid(xi,center);
[XI,SI]= meshgrid(x,s);
P = interp2(X,S,P,XI,SI,'linear');