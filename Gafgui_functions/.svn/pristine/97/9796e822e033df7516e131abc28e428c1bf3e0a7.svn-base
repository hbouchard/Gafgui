

% --------------------------------------------------------------------
function [P,XI,SI] = fct_makecorrmatrix3(p,x,x0,s)

Nbin = 64;
if length(x)< 3
    xmin = min(x);
    xmax = max(x);
    deltax = (xmax-xmin)/Nbin;
    x = xmin:deltax:xmax;
end
if length(s)< 3
    smin = min(s);
    smax = max(s);
    deltas = (smax-smin)/Nbin;
    s = smin:deltas:smax;
end
N = length(x);
P = [];
V = [];
maxorder = 12;
for n = 0:2:maxorder
    V = cat(2,V,(x(:)-x0).^n);
end
center(1:length(p)) = 0;
for i = 1:length(p)
    tmp = p{i};
    y = (V(:,1:length(tmp))*tmp)';
    norm = tmp(1);
    center(i) = norm;
    if max(y)==0
        P = cat(1,P,y*0+1);
    else
        P = cat(1,P,y/norm);
    end
end
%hold off;
%set(gca,'ylim',[0 length(p)*1.1]);
[X,S] = meshgrid(x,center);
[XI,SI]= meshgrid(x,s);
%%%%%
PI =  [];

%Ce parametre est completement empirique
Porder = 4;

for i=1:N
    f = P(:,i);
    %I don't understand why this doesn't work!
    %     q = fct_lsf((-log(center/65535)),1-f,3,1);
    %     q = flipud(q);
    %     q = [q(:)' 0];
    %     ffit = 1-polyval(q,-log(y/65535));
    qfit = fct_lsf((-log(center/65535)),1-f,Porder,1);
    F = fct_F_matrix((-log(max(1,s)/65535)),Porder,1);
    ffit = 1-F*qfit;
    ffit = max(ffit,0);
    ffit = min(ffit,1);
    PI = cat(2,PI,ffit(:));
end
%extrapolation
if center(1) == 0
else
    P = cat(1,y*0,P);
    center = [0 center(:)']';
end
if center(length(center)) == 65535
else
    P = cat(1,P,y*0+1);
    center = [center(:)' 65535]';
end
%%%%
%P = interp2(X,S,P,XI,SI,'linear');
P = PI;